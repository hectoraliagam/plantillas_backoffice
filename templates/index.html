<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Back Office HITSS - Generador</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div class="flex h-screen">
      <!-- SIDEBAR -->
      <aside class="w-72 bg-slate-900 text-white p-4 overflow-y-auto">
        <h1 class="text-xl font-bold mb-6 border-b border-slate-700 pb-2">
          Back Office HITSS
        </h1>

        {% for categoria, templates_categoria in templates.items() %}
        <div class="mb-6">
          <h2 class="text-sm uppercase text-slate-400 mb-2">{{ categoria }}</h2>

          <div class="space-y-1">
            {% for template_key, data in templates_categoria.items() %}
            <button
              onclick="selectTemplate('{{ template_key }}')"
              class="w-full text-left px-3 py-2 rounded hover:bg-slate-700 transition text-sm"
            >
              {{ template_key }}
            </button>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </aside>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="flex-1 p-8 overflow-y-auto">
        <!-- FORMULARIO DINÃMICO -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
          <h2 id="template-title" class="text-lg font-semibold mb-4">
            Selecciona una plantilla
          </h2>

          <form id="dynamic-form" class="space-y-4"></form>

          <div class="mt-6">
            <button
              onclick="generateTemplate()"
              class="bg-slate-900 text-white px-6 py-2 rounded hover:bg-slate-800 transition"
            >
              Generar Plantilla
            </button>
          </div>
        </div>

        <!-- RESULTADO -->
        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Resultado</h2>

            <button
              onclick="copyResult()"
              class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 transition text-sm"
            >
              Copiar
            </button>
          </div>

          <textarea
            id="result-box"
            class="w-full h-96 border rounded p-4 font-mono text-sm bg-gray-50"
            readonly
          ></textarea>
        </div>
      </main>
    </div>

    <script>

      let selectedTemplate = null;
      let templateFields = [];

      const TEMPLATES = {{ templates | tojson | safe }};

      function selectTemplate(templateKey) {

          selectedTemplate = templateKey;
          templateFields = [];

          for (const categoria in TEMPLATES) {
              if (TEMPLATES[categoria][templateKey]) {
                  templateFields = TEMPLATES[categoria][templateKey].fields || [];
                  break;
              }
          }

          document.getElementById("template-title").innerText = templateKey;

          renderForm();
      }


      function renderForm() {

          const form = document.getElementById("dynamic-form");
          form.innerHTML = "";

          if (!templateFields.length) {
              form.innerHTML = "<p class='text-gray-500'>Esta plantilla no tiene campos definidos.</p>";
              return;
          }

          templateFields.forEach(field => {

              const wrapper = document.createElement("div");

              const label = document.createElement("label");
              label.innerText = field.label || field.name || "Campo";
              label.className = "block text-sm font-medium mb-1";

              let input;

              if (field.type === "combo" && field.options) {

                  input = document.createElement("select");
                  input.className = "w-full border rounded px-3 py-2";

                  field.options.forEach(opt => {
                      const option = document.createElement("option");
                      option.value = opt;
                      option.innerText = opt;
                      input.appendChild(option);
                  });

              } else {

                  input = document.createElement("input");
                  input.type = "text";
                  input.className = "w-full border rounded px-3 py-2";
              }

              input.id = field.name;

              wrapper.appendChild(label);
              wrapper.appendChild(input);
              form.appendChild(wrapper);
          });
      }


      function generateTemplate() {

          if (!selectedTemplate) {
              alert("Selecciona una plantilla primero.");
              return;
          }

          const formData = {};

          templateFields.forEach(field => {
              formData[field.name] = document.getElementById(field.name)?.value || "";
          });

          fetch("/generate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                  template_key: selectedTemplate,
                  form_data: formData
              })
          })
          .then(res => res.json())
          .then(data => {
              if (data.result) {
                  document.getElementById("result-box").value = data.result;
              } else if (data.error) {
                  alert(data.error);
              } else {
                  alert("Error generando plantilla.");
              }
          });
      }


      function copyResult() {

          const textarea = document.getElementById("result-box");
          textarea.select();
          document.execCommand("copy");
      }
    </script>
  </body>
</html>
